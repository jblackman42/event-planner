<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('../partials/head'); %>
    </head>
<body>
    <%- include('../partials/loading'); %>

    <div id="calender-container">
        <div id="calender-controls">
            <button onClick="prevMonth()"><i class="material-icons">keyboard_arrow_left</i></button>
            <p id="date-label"></p>
            <button onClick="nextMonth()"><i class="material-icons">keyboard_arrow_right</i></button>
        </div>

        <div id="calender-labels">
            <p>sunday</p>
            <p>monday</p>
            <p>tuesday</p>
            <p>wednesday</p>
            <p>thursday</p>
            <p>friday</p>
            <p>saturday</p>
        </div>
        
        <div id="calender"></div>
    </div>
</body>
<script src="/scripts/calender.js"></script>
<script>
    let iteration = 0
    let right = false;
    let left = true;
    function getEvents() {
        loading();

        axios({
            method: 'get',
            url: `https://my.pureheart.org/ministryplatformapi/tables/events?%24orderby=Event_Start_Date%20DESC&%24skip=${1000 * iteration}`,
            headers: {
                'Accept': 'application/json',
                'Authorization': `Bearer ${access_token}`
            }
        })
            .then(response => response.data)
            .then(data => {
                //loop through all data
                //check if data date is in dates array
                //log data
                let monthHasEvents = false;

                for (let i = 0; i < data.length; i ++) {
                    const {Event_Start_Date} = data[i];
                    const eventDate = new Date(Event_Start_Date).toDateString();
                    // console.log(eventDate)
                    
                    const datesWithEvents = dates.filter(date => date.day == eventDate);
                    datesWithEvents.forEach(date => {
                        date.numberOfEvents ++;
                        monthHasEvents = true;
                    })
                }

                if (!monthHasEvents && right && iteration > 0) {
                    iteration --;
                    getEvents();
                } else if (!monthHasEvents && left) {
                    iteration ++;
                    getEvents();
                } else {
                    drawCalender();
                    doneLoading();
                }
            })
            .catch(err => {
                console.error(err)
            })
    }
    getEvents()

    function updateDates() {
        dates = getMonth(currentYear, currentMonth);
        getEvents()
    }
    function nextMonth() {
        right = true;
        left = false;
        const nextCurrMonth = currentMonth + 1;
        if (nextCurrMonth > 11) {
            currentYear ++;
            currentMonth = 0;
        } else {
            currentMonth ++;
        }
        updateDates();
    }
    function prevMonth() {
        right = false;
        left = true;
        const prevCurrMonth = currentMonth - 1;
        if (prevCurrMonth < 0) {
            currentYear --;
            currentMonth = 11;
        } else {
            currentMonth --;
        }
        updateDates();
    }
</script>
</html>